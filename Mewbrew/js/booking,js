// booking.js - Enhanced booking functionality for MewBrew Café
document.addEventListener('DOMContentLoaded', function() {
    // Initialize booking system
    const bookingSystem = new BookingSystem();
    bookingSystem.init();
});

class BookingSystem {
    constructor() {
        // DOM Elements
        this.bookingForm = document.querySelector('.booking-form');
        this.guestsInput = document.getElementById('guests');
        this.decreaseBtn = document.getElementById('decrease');
        this.increaseBtn = document.getElementById('increase');
        this.categorySelect = document.getElementById('category');
        this.dateInput = document.getElementById('date');
        this.timeSelect = document.getElementById('time');
        
        // Summary elements
        this.summaryGuests = document.getElementById('summary-guests');
        this.summaryRate = document.getElementById('summary-rate');
        this.summaryTotal = document.getElementById('summary-total');
        
        // Price configuration
        this.PRICES = {
            standard: 200,
            student: 150,
            group: 170
        };
        
        // Time slots
        this.TIME_SLOTS = [
            '10:00', '11:00', '12:00', '13:00', '14:00', 
            '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'
        ];
        
        // Booking data
        this.bookingData = {
            guests: 1,
            category: 'standard',
            date: '',
            time: '',
            total: this.PRICES.standard
        };
    }

    init() {
        this.setupDatePicker();
        this.setupGuestCounter();
        this.setupEventListeners();
        this.updateSummary();
        
        console.log('MewBrew Booking System initialized');
    }

    setupDatePicker() {
        // Set minimum date to today
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Format: YYYY-MM-DD
        const todayFormatted = today.toISOString().split('T')[0];
        const tomorrowFormatted = tomorrow.toISOString().split('T')[0];
        
        this.dateInput.setAttribute('min', todayFormatted);
        this.dateInput.value = tomorrowFormatted;
        
        // Store date in booking data
        this.bookingData.date = tomorrowFormatted;
        
        // Disable weekends (optional)
        this.dateInput.addEventListener('change', (e) => {
            const selectedDate = new Date(e.target.value);
            const day = selectedDate.getDay();
            
            // 0 = Sunday, 6 = Saturday
            if (day === 0 || day === 6) {
                this.showAlert('Please note: Weekends might be busier. Consider booking in advance!', 'info');
            }
            
            this.bookingData.date = e.target.value;
            this.checkAvailability();
        });
    }

    setupGuestCounter() {
        // Decrease guests
        this.decreaseBtn.addEventListener('click', () => {
            let currentValue = parseInt(this.guestsInput.value);
            if (currentValue > 1) {
                this.guestsInput.value = currentValue - 1;
                this.bookingData.guests = this.guestsInput.value;
                this.updateSummary();
                this.animateCounter('decrease');
            }
        });

        // Increase guests
        this.increaseBtn.addEventListener('click', () => {
            let currentValue = parseInt(this.guestsInput.value);
            if (currentValue < 10) {
                this.guestsInput.value = currentValue + 1;
                this.bookingData.guests = this.guestsInput.value;
                this.updateSummary();
                this.animateCounter('increase');
                
                if (currentValue + 1 >= 5) {
                    this.categorySelect.value = 'group';
                    this.bookingData.category = 'group';
                    this.updateSummary();
                    this.showAlert('Group discount applied! ₱170 per person', 'success');
                }
            }
        });

        // Direct input change
        this.guestsInput.addEventListener('change', () => {
            let value = parseInt(this.guestsInput.value);
            
            // Validate range
            if (value < 1) {
                value = 1;
                this.guestsInput.value = 1;
            } else if (value > 10) {
                value = 10;
                this.guestsInput.value = 10;
                this.showAlert('Maximum 10 guests per booking', 'warning');
            }
            
            this.bookingData.guests = value;
            this.updateSummary();
            
            // Auto-select group category for 5+ guests
            if (value >= 5 && this.categorySelect.value !== 'group') {
                this.categorySelect.value = 'group';
                this.bookingData.category = 'group';
                this.updateSummary();
                this.showAlert('Group discount applied! ₱170 per person', 'success');
            }
        });
    }

    setupEventListeners() {
        // Category change
        this.categorySelect.addEventListener('change', (e) => {
            this.bookingData.category = e.target.value;
            
            // Validate group category
            if (e.target.value === 'group' && this.bookingData.guests < 5) {
                this.showAlert('Group booking requires 5 or more guests', 'warning');
                this.categorySelect.value = 'standard';
                this.bookingData.category = 'standard';
            }
            
            // Validate student/senior category
            if (e.target.value === 'student') {
                this.showAlert('Please bring valid ID for student/senior discount', 'info');
            }
            
            this.updateSummary();
        });

        // Time selection
        this.timeSelect.addEventListener('change', (e) => {
            this.bookingData.time = e.target.value;
            
            // Suggest popular times
            const popularTimes = ['14:00', '16:00', '18:00'];
            if (popularTimes.includes(e.target.value)) {
                this.showAlert('This is a popular time slot!', 'info');
            }
        });

        // Form submission
        if (this.bookingForm) {
            this.bookingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (this.validateForm()) {
                    this.processBooking();
                }
            });
        }
    }

    updateSummary() {
        const guests = parseInt(this.bookingData.guests);
        const category = this.bookingData.category;
        const rate = this.PRICES[category] || this.PRICES.standard;
        const total = guests * rate;
        
        // Update DOM
        this.summaryGuests.textContent = guests;
        this.summaryRate.textContent = `₱${rate}`;
        this.summaryTotal.textContent = `₱${total}`;
        
        // Store total
        this.bookingData.total = total;
        
        // Add animation to total
        this.animateTotalUpdate();
    }

    validateForm() {
        let isValid = true;
        
        // Check if form has Bootstrap validation class
        if (this.bookingForm.classList.contains('needs-validation')) {
            if (!this.bookingForm.checkValidity()) {
                isValid = false;
                this.bookingForm.classList.add('was-validated');
                this.showAlert('Please fill all required fields correctly', 'warning');
            }
        }
        
        // Additional custom validation
        if (this.bookingData.guests < 1) {
            this.showAlert('Please select at least 1 guest', 'warning');
            isValid = false;
        }
        
        if (!this.bookingData.date) {
            this.showAlert('Please select a visit date', 'warning');
            isValid = false;
        }
        
        if (!this.bookingData.time) {
            this.showAlert('Please select a time slot', 'warning');
            isValid = false;
        }
        
        // Check date is not in the past
        const selectedDate = new Date(this.bookingData.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            this.showAlert('Please select a future date', 'warning');
            isValid = false;
        }
        
        return isValid;
    }

    processBooking() {
        // Show loading state
        const submitBtn = this.bookingForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        submitBtn.disabled = true;
        
        // Simulate API call
        setTimeout(() => {
            // Store booking in localStorage (for demo purposes)
            const bookings = JSON.parse(localStorage.getItem('mewbrew_bookings') || '[]');
            const bookingId = 'BOOK-' + Date.now();
            
            const completeBooking = {
                id: bookingId,
                ...this.bookingData,
                timestamp: new Date().toISOString(),
                status: 'confirmed'
            };
            
            bookings.push(completeBooking);
            localStorage.setItem('mewbrew_bookings', JSON.stringify(bookings));
            
            // Show success modal (create if doesn't exist)
            this.createSuccessModal(completeBooking);
            
            // Reset form
            this.resetForm();
            
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            // Log booking
            console.log('Booking processed:', completeBooking);
            
        }, 1500);
    }

    createSuccessModal(booking) {
        // Create modal if it doesn't exist
        if (!document.getElementById('bookingSuccessModal')) {
            const modalHTML = `
                <div class="modal fade" id="bookingSuccessModal" tabindex="-1" aria-labelledby="bookingSuccessModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header border-0">
                                <h5 class="modal-title text-center w-100" id="bookingSuccessModalLabel">Booking Confirmed!</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <i class="fas fa-calendar-check fa-4x text-warning mb-3"></i>
                                <h4 class="mb-3">Thank You for Booking!</h4>
                                <div class="booking-details mb-3 p-3 bg-light rounded">
                                    <p class="mb-1"><strong>Booking ID:</strong> ${booking.id}</p>
                                    <p class="mb-1"><strong>Date:</strong> ${this.formatDate(booking.date)}</p>
                                    <p class="mb-1"><strong>Time:</strong> ${booking.time}:00</p>
                                    <p class="mb-1"><strong>Guests:</strong> ${booking.guests}</p>
                                    <p class="mb-1"><strong>Total:</strong> ₱${booking.total}</p>
                                </div>
                                <p class="mb-2">Your reservation has been confirmed.</p>
                                <p class="mb-0">A confirmation email will be sent to you shortly.</p>
                            </div>
                            <div class="modal-footer border-0 justify-content-center">
                                <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Done</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                                    <i class="fas fa-print me-2"></i>Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Update modal content
        const modalBody = document.querySelector('#bookingSuccessModal .modal-body .booking-details');
        if (modalBody) {
            modalBody.innerHTML = `
                <p class="mb-1"><strong>Booking ID:</strong> ${booking.id}</p>
                <p class="mb-1"><strong>Date:</strong> ${this.formatDate(booking.date)}</p>
                <p class="mb-1"><strong>Time:</strong> ${booking.time}:00</p>
                <p class="mb-1"><strong>Guests:</strong> ${booking.guests}</p>
                <p class="mb-1"><strong>Total:</strong> ₱${booking.total}</p>
            `;
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('bookingSuccessModal'));
        modal.show();
    }

    resetForm() {
        if (this.bookingForm) {
            this.bookingForm.reset();
            this.bookingForm.classList.remove('was-validated');
            
            // Reset booking data
            this.bookingData = {
                guests: 1,
                category: 'standard',
                date: '',
                time: '',
                total: this.PRICES.standard
            };
            
            // Reset date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            this.dateInput.value = tomorrow.toISOString().split('T')[0];
            this.bookingData.date = this.dateInput.value;
            
            // Reset guests input
            this.guestsInput.value = 1;
            
            // Reset category
            this.categorySelect.value = 'standard';
            
            // Reset time
            this.timeSelect.value = '';
            
            // Update summary
            this.updateSummary();
        }
    }

    checkAvailability() {
        // In a real application, this would call an API
        // For demo, simulate availability check
        const selectedDate = new Date(this.bookingData.date);
        const day = selectedDate.getDay();
        
        // Simulate busy days
        if (day === 5 || day === 6) { // Friday or Saturday
            this.showAlert('Weekends are popular! Some time slots may be limited.', 'info');
        }
    }

    showAlert(message, type = 'info') {
        // Remove existing alerts
        const existingAlert = document.querySelector('.booking-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `booking-alert alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.style.width = '90%';
        alertDiv.style.maxWidth = '500px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to DOM
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    animateCounter(direction) {
        const counter = this.guestsInput;
        counter.classList.remove('animate-increase', 'animate-decrease');
        
        void counter.offsetWidth; // Trigger reflow
        
        if (direction === 'increase') {
            counter.classList.add('animate-increase');
        } else {
            counter.classList.add('animate-decrease');
        }
        
        // Remove animation class after animation completes
        setTimeout(() => {
            counter.classList.remove('animate-increase', 'animate-decrease');
        }, 300);
    }

    animateTotalUpdate() {
        const totalElement = this.summaryTotal;
        totalElement.classList.remove('highlight-total');
        
        void totalElement.offsetWidth; // Trigger reflow
        
        totalElement.classList.add('highlight-total');
        
        // Remove animation class after animation completes
        setTimeout(() => {
            totalElement.classList.remove('highlight-total');
        }, 600);
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
}